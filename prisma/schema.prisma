// ---------- GENERATOR / DATASOURCE ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum Role {
  ADMIN
  USER
}

enum PolicyStatus {
  DRAFT
  ACTIVE
  LAPSED
  CANCELLED
  EXPIRED
}

enum PersonType {
  PF
  PJ
}

enum ClientStatus {
  LEAD
  PROSPECT
  ACTIVE
  INACTIVE
}

// Health
enum BeneficiarioTipo {
  TITULAR
  DEPENDENTE
}

enum BeneficiarioStatus {
  ATIVO
  INATIVO
}

// ---------- CORE ----------
model Corretor {
  id         String   @id @default(cuid())
  name       String
  cpfCnpj    String   @unique
  email      String   @unique @db.Citext
  phone      String?
  subdomain  String   @unique
  slug       String   @unique
  tenantCode String?  @unique @db.VarChar(16)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users    User[]
  clients  Client[]
  policies Policy[] @relation("PolicyCorretor")
}

model User {
  id           String @id @default(cuid())
  name         String
  email        String @db.Citext
  passwordHash String
  role         Role   @default(USER)

  corretorId String
  corretor   Corretor @relation(fields: [corretorId], references: [id], onDelete: Cascade)

  refreshTokenHash String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([corretorId, email]) // e-mail único por tenant
  @@index([corretorId])
  @@index([refreshTokenHash])
  @@index([email])
}

model Client {
  id         String   @id @default(cuid())
  corretorId String
  corretor   Corretor @relation(fields: [corretorId], references: [id], onDelete: Cascade)

  name      String
  email     String?   @db.Citext
  document  String?   @db.VarChar(32)
  phone     String?   @db.VarChar(32)
  birthDate DateTime?
  notes     String?

  personType PersonType   @default(PF)
  status     ClientStatus @default(ACTIVE)
  tags       String[]     @default([])

  // endereço (legado)
  addressZip        String?
  addressStreet     String?
  addressNumber     String?
  addressComplement String?
  addressDistrict   String?
  addressCity       String?
  addressState      String?
  addressCountry    String? @default("BR")

  // contato principal (legado)
  primaryContactName  String?
  primaryContactRole  String?
  primaryContactEmail String?
  primaryContactPhone String?
  primaryContactNotes String?

  // PF extras
  pfRg            String?
  pfMaritalStatus String?
  pfProfession    String?
  pfIsPEP         Boolean?

  // PJ extras
  pjCorporateName         String?
  pjTradeName             String?
  pjCnpj                  String?
  pjStateRegistration     String?
  pjMunicipalRegistration String?
  pjCNAE                  String?
  pjFoundationDate        DateTime?
  pjRepName               String?
  pjRepCpf                String?
  pjRepEmail              String?
  pjRepPhone              String?

  preferences    Json?
  marketingOptIn Boolean @default(false)
  privacyConsent Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // <— Soft delete

  policies       Policy[]          @relation("PolicyClient")
  beneficiarios  Beneficiario[]
  regrasCobranca RegraCobranca[]
  faturas        FaturaImportada[]

  // NOVO: relações normalizadas (Fase A)
  addresses Address[]
  contacts  Contact[]

  @@unique([corretorId, id])
  // ⚠️ NÃO usamos mais @@unique para email/document aqui por causa do soft delete.
  // Unicidade é garantida por índices parciais criados via SQL (ver migração).
  @@index([corretorId, email])
  @@index([corretorId, name])
  @@index([corretorId, status])
  @@index([corretorId, createdAt])
  @@index([corretorId, document])
  @@index([corretorId, deletedAt]) // <— para filtrar ativos
  @@map("clients")
}

model Policy {
  id         String @id @default(cuid())
  corretorId String
  clientId   String

  corretor Corretor @relation("PolicyCorretor", fields: [corretorId], references: [id], onDelete: Cascade)
  client   Client   @relation("PolicyClient", fields: [corretorId, clientId], references: [corretorId, id], onDelete: Cascade)

  policyNumber String
  insurer      String
  product      String?
  startDate    DateTime
  endDate      DateTime?
  premium      Decimal      @db.Decimal(12, 2)
  status       PolicyStatus @default(DRAFT)
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([corretorId, policyNumber])
  @@index([corretorId, clientId])
  @@index([corretorId, status])
  @@index([corretorId, startDate])
  @@map("policies")
}

// ---------- HEALTH ----------
model RegraCobranca {
  id                String   @id @default(cuid())
  clientId          String
  cliente           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  descricao         String
  dataCorteCobranca Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  beneficiarios Beneficiario[]

  @@index([clientId])
  @@map("health_billing_rules")
}

model Beneficiario {
  id       String @id @default(cuid())
  clientId String
  cliente  Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  titularId   String?
  titular     Beneficiario?  @relation("TitularDependentes", fields: [titularId], references: [id], onDelete: SetNull)
  dependentes Beneficiario[] @relation("TitularDependentes")

  nomeCompleto     String
  cpf              String?            @db.VarChar(14)
  tipo             BeneficiarioTipo
  dataEntrada      DateTime
  dataSaida        DateTime?
  valorMensalidade Decimal?           @db.Decimal(10, 2)
  status           BeneficiarioStatus @default(ATIVO)

  regraCobrancaId String?
  regraCobranca   RegraCobranca? @relation(fields: [regraCobrancaId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, cpf])
  @@index([clientId, tipo])
  @@index([clientId, status])
  @@index([clientId, titularId])
  @@map("health_beneficiaries")
}

model FaturaImportada {
  id       String @id @default(cuid())
  clientId String
  cliente  Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  mesReferencia             DateTime
  nomeBeneficiarioOperadora String?
  cpfBeneficiarioOperadora  String?  @db.VarChar(14)
  valorCobradoOperadora     Decimal? @db.Decimal(10, 2)
  statusConciliacao         String?

  raw       Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId, mesReferencia])
  @@map("health_imported_invoices")
}

// ---------- NORMALIZAÇÃO ----------
model Address {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  type       String  @default("COBRANCA")
  zip        String?
  street     String?
  number     String?
  complement String?
  district   String?
  city       String?
  state      String?
  country    String  @default("BR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@map("enderecos")
}

model Contact {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name      String?
  role      String?
  email     String? @db.Citext
  phone     String?
  notes     String?
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@map("contatos")
}

// ---------- AUDIT ----------
model AuditLog {
  id         String   @id @default(cuid())
  corretorId String
  entity     String   // "client" | "address" | "contact"
  entityId   String
  action     String   // "create" | "update" | "delete" | "restore"
  before     Json?
  after      Json?
  actorId    String?
  ip         String?
  userAgent  String?
  at         DateTime @default(now())

  @@index([corretorId, entity, entityId, at])
  @@map("audit_log")
}
